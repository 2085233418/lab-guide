## 1.1 去除标准库依赖

#### 添加 `#![no_std]` 声明

要编写一个操作系统内核，我们需要编写不依赖任何操作系统特性的代码，因为我们正在编写自己的操作系统和硬件驱动。

这意味着我们不能使用 **Rust标准库**的大部分；但还有很多 Rust 特性是我们依然可以使用的。比如说，我们可以使用**迭代器、闭包、模式匹配、Option、Result、字符串格式化**，当然还有**所有权系统**。这些功能让我们能够编写表达性强、高层抽象的操作系统，而无需关心**未定义行为**和**内存安全**。

为了用 Rust 编写一个操作系统内核，我们需要创建一个独立于操作系统的可执行程序（这样的可执行程序常被称作**裸机程序**）。因此我们必须禁用**标准库自动引用**，使用`no_std`属性可以实现这一点。

前文已创建如下的项目结构：

```
ErrorOS/
├── os/                         # 内核代码目录
│   ├── .cargo/
│   │   └── config.toml         # Cargo 配置
│   ├── src/
│   │   └──  main.rs             # 内核主程序
│   └── Cargo.toml              # 项目配置
└── README.md                   # 项目说明
```

**首先：修改 `main.rs`**

在 `os/src/main.rs` 开头添加：

```rust
#![no_std]      // 不链接 Rust 标准库
```

尝试编译一下

```bash
cd os
cargo build
```

**预期错误**

```
error: cannot find macro `println` in this scope
 --> src/main.rs:5:5
  |
5 |     println!("Hello, world!");
  |     ^^^^^^^

error: `#[panic_handler]` function required, but not found
```

这些错误是正常的，因为main.rs文件中的`println!`宏也是标准库的一部分，你可以去除`println!(“Hello，world!”)；`这行代码，使用一个空的main函数再次尝试编译。

---

#### 添加 `#![no_main]` 声明

Rust 程序的标准入口点是 `main` 函数，它由 `crt0`（C 运行时）调用。在裸机环境中，没有 `crt0` 运行时，需要自定义入口点 `_start`，因而使用 `#![no_main]` 禁用标准入口点

同样，在 `os/src/main.rs` 开头添加：

```rust
#![no_main]
```

值得一提的是，因为没有底层运行时调用`main`函数，所以我们删掉了代码中的`fn main{}`。

---

#### 实现panic处理函数

当程序发生 panic（运行时错误）时，需要有处理函数。标准库提供了默认的 panic handler，但在 `no_std` 环境中我们需要自己定义一个。

在 `main.rs` 中添加：

```rust
use core::panic::PanicInfo;

/// Panic 处理函数，当程序发生 panic 时调用此函数
#[panic_handler]
fn panic(info: &PanicInfo) -> ! {
    loop {}
}
```

类型为`PanicInfo` 的参数包含 panic 的信息（文件名、位置、错误信息等）。这是一个发散函数，它从不返回，对于这样的函数，我们目前能做的很少，所以我们先只写一个无限循环`loop{}`。

---

#### 禁用栈展开

Rust 的 panic 有两种处理模式：

1. **unwind**（展开）: 回溯调用栈，执行清理代码
2. **abort**（终止）: 直接终止程序

在裸机环境中，展开栈需要复杂的运行时支持，因此我们使用 `abort` 模式。

把以下几行设置代码加入到我们的 `os/Cargo.toml` 中：

```toml
[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"
```

**验证配置**

```bash
cargo build
```

这些选项能将 **dev 配置**和 **release 配置**的 panic 策略设为 `abort`。dev 配置适用于 `cargo build`，而 release 配置适用于 `cargo build --release`。现在应该不再有关于 `eh_personality` 的错误。不过又会出现新问题：

```
error: requires `start` lang_item
```

