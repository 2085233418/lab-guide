# 第 7 章：文件系统

## 本章概述

> "一切皆文件。"

文件系统是操作系统的"档案管理员"。本章将实现 VFS（虚拟文件系统）抽象和内存文件系统（RamFS），学习 Inode、文件描述符、以及文件系统调用的实现。

---

## 学习目标

完成本章学习后，你将能够：

- ✅ 理解 VFS（虚拟文件系统）的设计思想
- ✅ 掌握 Trait Object（动态多态）的使用
- ✅ 实现 File trait 和 Inode trait
- ✅ 设计文件描述符表
- ✅ 实现标准输入输出（stdin/stdout/stderr）
- ✅ 编写内存文件系统（RamFS）
- ✅ 实现文件系统调用（open/read/write/close/mkdir）

---

## 内容导览

### 7.1.1 VFS 设计与 File trait
学习 VFS 的设计理念，定义 `File` trait，统一所有文件类型的接口。

**关键概念：**
- VFS（Virtual File System）
- Trait Object（`dyn File`）
- 动态多态
- "一切皆文件"

### 7.1.2 Inode 抽象和权限管理
定义 `Inode` trait，实现文件的元数据管理和权限检查。

**关键概念：**
- Inode（索引节点）
- 文件类型（6种）
- 文件权限（rwx）
- 元数据

### 7.1.3 文件描述符表设计
设计进程级别的文件描述符表，管理打开的文件。

**关键概念：**
- 文件描述符（fd）
- 文件描述符表
- 0/1/2（stdin/stdout/stderr）

### 7.1.4 标准输入输出实现
实现 `Stdin`、`Stdout`、`Stderr`，为进程提供标准 I/O。

**关键概念：**
- 标准输入（stdin）
- 标准输出（stdout）
- 标准错误（stderr）
- 字符设备

### 7.2.1 RamInode 设计和文件读写
实现内存 Inode，支持文件的读写操作。

**关键概念：**
- 内存文件系统
- 文件内容缓存
- 读写位置

### 7.2.2 目录操作实现
实现目录的创建、查找、遍历等操作。

**关键概念：**
- 目录项
- 路径解析
- 目录树

### 7.2.3 RamFile 和 RamFS 实现
实现 `RamFile` 和 `RamFS`，完成内存文件系统。

**关键概念：**
- RamFile（内存文件）
- RamFS（根文件系统）
- 文件系统挂载

### 7.2.4 全局管理器和模块导出
实现全局文件系统管理器，提供统一的访问接口。

**关键概念：**
- 全局文件系统
- 根目录
- 模块封装

### 7.3.1 系统调用号定义和 read_write 实现
定义文件系统调用号，实现 `sys_read` 和 `sys_write`。

**关键概念：**
- 系统调用号
- 用户缓冲区检查
- 返回值语义

### 7.3.2 open 系统调用和 C 字符串处理
实现 `sys_open`，学习如何处理 C 风格字符串。

**关键概念：**
- `sys_open`
- 打开标志（O_RDONLY/O_WRONLY/O_RDWR）
- C 字符串转换

### 7.3.3 close 和 mkdir 系统调用
实现 `sys_close` 和 `sys_mkdir`，完善文件系统调用。

**关键概念：**
- `sys_close`
- `sys_mkdir`
- 错误处理

### 7.3.4 系统调用分发和集成测试
集成所有文件系统调用，编写完整的测试用例。

**关键概念：**
- 系统调用分发
- 集成测试
- 边界条件

### 7.4.1 测试框架搭建
搭建文件系统测试框架，验证各项功能。

**关键概念：**
- 单元测试
- 集成测试
- 测试驱动开发

---

## 为什么重要？

文件系统是操作系统的"持久化层"：

1. **数据持久化**：保存程序和数据
2. **统一抽象**：设备、套接字、管道都是"文件"
3. **权限管理**：保护数据安全

---

## 技术亮点

- 🎭 **Trait Object**：动态多态的优雅应用
- 📁 **VFS 抽象**：支持多种文件系统
- 🔐 **权限管理**：保护文件安全

---

## 预计时间

⏱️ **约 6-8 小时**（本章内容较多）

---

## 开始学习

让我们构建文件系统！

👉 [7.1.1 VFS 设计与 File trait](../实验指导书汇总/7.1.1-VFS设计与File%20trait.md)
