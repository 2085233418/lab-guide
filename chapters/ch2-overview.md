# 第 2 章：异常与中断

## 本章概述

> "预则立，不预则废。"

异常和中断是操作系统与硬件交互的核心机制。本章将深入 RISC-V 特权级架构，实现完整的异常处理框架，为后续的系统调用和进程管理打下基础。

---

## 学习目标

完成本章学习后，你将能够：

-  理解 RISC-V 的三种特权级（M/S/U）
-  掌握 CSR（控制状态寄存器）的作用
-  区分异常（Exception）和中断（Interrupt）
-  实现异常处理入口（汇编）
-  编写异常分发器（Rust）
-  配置中断使能和屏蔽
-  测试异常处理流程

---

## 内容导览

### 2.1 RISC-V 特权级架构
学习 RISC-V 的三种特权级模式：M（机器态）、S（监督态）、U（用户态），理解它们的权限和用途。

**关键概念：**
- 特权级模式（M/S/U）
- 特权级切换
- OpenSBI 的角色

### 2.2 异常处理机制
深入理解异常和中断的区别，学习 RISC-V 异常处理的五大 CSR 寄存器。

**关键概念：**
- `stvec`（异常向量表基址）
- `scause`（异常原因）
- `sepc`（异常返回地址）
- `stval`（异常相关值）
- `sstatus`（状态寄存器）

### 2.3 中断描述符表
配置 `stvec` 寄存器，选择 Direct 或 Vectored 模式。

**关键概念：**
- Direct 模式
- Vectored 模式
- 中断向量表

### 2.4 异常处理入口
用汇编实现异常处理入口，保存和恢复上下文（寄存器）。

**关键概念：**
- 上下文保存
- 栈帧布局
- `csrrw` 指令

### 2.5 异常分发器
用 Rust 实现异常分发器，根据 `scause` 分发到不同的处理函数。

**关键概念：**
- `scause` 解码
- 异常类型枚举
- 错误处理

### 2.6 中断使能与屏蔽
配置 `sie`（Supervisor Interrupt Enable）和 `sstatus` 寄存器，开启中断。

**关键概念：**
- `sie` 寄存器
- `sstatus.SIE` 位
- 中断屏蔽

### 2.7 测试异常处理
触发各种异常（非法指令、页错误等），验证异常处理流程。

**关键概念：**
- 非法指令异常
- 断点异常
- 调试技巧

---

## 为什么重要？

异常和中断是操作系统的"神经系统"：

1. **系统调用基础**：系统调用就是通过 `ecall` 触发异常实现的
2. **进程管理基础**：时钟中断是进程调度的触发源
3. **错误处理**：页错误、非法指令等异常需要内核处理

---

## 技术亮点

-  **汇编与 Rust 协作**：汇编保存上下文，Rust 处理逻辑
-  **异常分发模式**：优雅的枚举匹配处理
-  **安全性**：特权级隔离保护内核

---

## 预计时间

 **约 3-4 小时**

---

## 开始学习

让我们深入 RISC-V 特权级的世界！

 [2.1 RISC-V 特权级架构](../实验指导书汇总/2.1%20RISC-V特权级架构.md)
