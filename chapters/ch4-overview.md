# 第 4 章：虚拟内存管理

## 本章概述

> "抽象是计算机科学的核心武器。"

虚拟内存是现代操作系统最重要的抽象之一。本章将深入学习虚拟内存的原理，实现 RISC-V Sv39 页表机制，建立虚拟地址到物理地址的映射。

---

## 学习目标

完成本章学习后,你将能够：

- ✅ 理解虚拟内存的四大优势
- ✅ 掌握 RISC-V Sv39 页表机制
- ✅ 实现页表项（PTE）和页表的抽象
- ✅ 编写虚拟地址到物理地址的映射函数
- ✅ 配置 `satp` 寄存器，启用虚拟内存
- ✅ 理解内核地址空间布局

---

## 内容导览

### 4.1 为什么需要虚拟内存
通过生动的类比，理解虚拟内存解决的四大问题：碎片化、地址冲突、隔离性、内存利用率。

**关键概念：**
- 内存碎片化
- 地址空间隔离
- 延迟分配
- 共享内存

### 4.2.1 物理帧分配器实现
优化物理页帧分配器，支持分配和回收。

**关键概念：**
- 栈式分配器
- 空闲链表
- 分配策略

### 4.2.2 集成到系统
将页帧分配器集成到内核，提供统一的分配接口。

**关键概念：**
- 全局分配器实例
- 初始化流程
- 错误处理

### 4.3 建立虚拟内存到物理内存的映射
实现页表项（PTE）、页表、地址空间的抽象，编写 `map` 和 `unmap` 函数。

**关键概念：**
- 页表项（PTE）
- 三级页表
- 权限位（R/W/X/U）
- TLB（快表）

### 4.4 从物理内存到虚拟内存的代码实现
配置内核地址空间，启用虚拟内存，完成从物理地址到虚拟地址的切换。

**关键概念：**
- `satp` 寄存器
- Sv39 分页模式
- 恒等映射
- 跳板页
- 内核重定位

---

## 为什么重要？

虚拟内存是操作系统的"魔法"：

1. **进程隔离**：每个进程有独立的地址空间，互不干扰
2. **内存保护**：页表权限位防止非法访问
3. **灵活性**：支持写时复制、内存映射文件等高级特性

---

## 技术亮点

- 🗺️ **三级页表**：理解多级页表的空间优势
- 🔐 **权限控制**：页表权限位保护内核
- 🚀 **TLB 优化**：理解硬件加速的重要性

---

## 预计时间

⏱️ **约 4-5 小时**

---

## 开始学习

让我们进入虚拟内存的世界！

👉 [4.1 为什么需要虚拟内存](../实验指导书汇总/4.1为什么需要虚拟内存.md)
