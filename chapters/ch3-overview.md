# 第 3 章：物理内存管理

## 本章概述

> "巧妇难为无米之炊。"

内存是操作系统最宝贵的资源。本章将实现物理内存管理器，学习如何分配和回收物理页帧，并搭建堆分配器，让内核能够使用 `Vec`、`Box` 等动态数据结构。

---

## 学习目标

完成本章学习后，你将能够：

-  理解物理内存布局（QEMU virt 机器）
-  实现物理地址和页帧的抽象
-  编写 Bump Allocator（物理页帧分配器）
-  集成 `linked_list_allocator` 堆分配器
-  使用 `Vec`、`Box` 等动态数据结构
-  测试动态内存分配

---

## 内容导览

### 3.1 物理内存管理
学习 QEMU virt 机器的内存布局，了解哪些内存区域可用，哪些被 OpenSBI 占用。

**关键概念：**
- QEMU virt 内存映射
- OpenSBI 固件区域
- 可用内存范围
- 链接器脚本符号

### 3.2 物理地址抽象
定义 `PhysAddr` 类型，封装物理地址的操作（对齐、页号计算等）。

**关键概念：**
- 物理地址
- 页大小（4KB）
- 地址对齐
- 类型安全

### 3.3 物理页帧定义
定义 `PhysPageNum` 和 `FrameTracker`，实现页帧的分配和自动回收。

**关键概念：**
- 物理页号
- 页帧追踪器
- RAII（资源获取即初始化）

### 3.4 实现 Bump Allocator（物理页帧分配器）
实现最简单的页帧分配器——Bump Allocator，像栈一样分配内存。

**关键概念：**
- Bump Allocator 原理
- 单调递增分配
- 全局分配器

### 3.5 实现堆分配器
集成 `linked_list_allocator`，为内核提供堆内存（支持 `alloc` 库）。

**关键概念：**
- 全局堆分配器
- `#[global_allocator]`
- `alloc` crate
- 堆内存布局

### 3.6 测试动态内存分配
测试 `Vec`、`Box`、`String` 等动态数据结构，验证堆分配器工作正常。

**关键概念：**
- 单元测试
- `Vec` 动态数组
- `Box` 智能指针
- 内存泄漏检测

---

## 为什么重要？

物理内存管理是操作系统的"资源调度中心"：

1. **虚拟内存基础**：物理页帧是虚拟内存的"砖块"
2. **动态数据结构**：有了堆，才能使用 `Vec`、`HashMap` 等
3. **资源管理**：学习如何高效、安全地管理有限资源

---

## 技术亮点

-  **RAII 模式**：`FrameTracker` 自动回收页帧，避免内存泄漏
-  **并发安全**：使用 `Mutex` 保护全局分配器
-  **单元测试**：验证分配器正确性

---

## 预计时间

 **约 3-4 小时**

---

## 开始学习

让我们开始管理物理内存！

 [3.1 物理内存管理](../实验指导书汇总/3.1%20物理内存管理.md)
